services:
  postgres:
    image: postgres:16-alpine
    ports:
      - "5434:5432"
    environment:
      POSTGRES_USER: prophet
      POSTGRES_PASSWORD: prophet
      POSTGRES_DB: prophet
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U prophet"]
      interval: 5s
      timeout: 3s
      retries: 10

  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: ["anvil", "--host", "0.0.0.0"]
    ports:
      - "8545:8545"
    healthcheck:
      test: ["CMD", "cast", "bn", "--rpc-url", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 10

  contracts:
    image: ghcr.io/foundry-rs/foundry:latest
    depends_on:
      anvil:
        condition: service_healthy
    working_dir: /app
    volumes:
      - ./packages/contracts:/app
    entrypoint: ["forge", "script", "script/Deploy.s.sol", "--rpc-url", "http://anvil:8545", "--broadcast"]
    environment:
      # Default anvil private key (account 0)
      PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"

  agent:
    build:
      context: .
      dockerfile: packages/agent/Dockerfile
    depends_on:
      contracts:
        condition: service_completed_successfully
    ports:
      - "3001:3001"
    env_file:
      - path: .env
        required: false
    environment:
      RPC_URL: http://anvil:8545
      PORT: "3001"
      DATABASE_URL: postgresql://prophet:prophet@postgres:5432/prophet

  platform:
    build:
      context: .
      dockerfile: packages/platform/Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "4000:4000"
    env_file:
      - path: .env
        required: false
    environment:
      DATABASE_URL: postgresql://prophet:prophet@postgres:5432/prophet
      PORT: "4000"

  frontend:
    build:
      context: .
      dockerfile: packages/frontend/Dockerfile
    depends_on:
      - agent
      - platform
    ports:
      - "3000:3000"
    environment:
      AGENT_URL: http://agent:3001
      NEXT_PUBLIC_PLATFORM_URL: http://localhost:4000
      HOSTNAME: "0.0.0.0"
      PORT: "3000"

volumes:
  pgdata:
