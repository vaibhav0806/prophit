# Incident Report: Test Run 2026-02-25

## Summary

Agent ran 3 trades in ~30 seconds. All 3 had the same failure pattern: Predict leg filled, Probable leg rejected ("tick size" error), unwind failed ("amount mismatch" error). Result: $8 of USDT converted to Predict tokens that couldn't be sold back. No money is lost — it's sitting as tokens in the EOA wallet — but it's illiquid until manually unwound or the bugs are fixed.

---

## Wallets

| Wallet | Address |
|--------|---------|
| EOA | `0xdAD013D95aCB067B2431fde18cbAc2BC92EF6B6C` |
| Safe | `0xD2d193AbB6Ca9365C4D32E52e26a7264F30FfCF9` |

## Agent Config (at time of trades)

| Setting | Value |
|---------|-------|
| maxTradeSize | $8 (per-leg = $4) |
| minTradeSize | $3 |
| minSpreadBps | 150 |
| executionMode | clob |
| dryRun | false |

---

## Money Trail

### Starting Balances (before agent start)

| Wallet | Balance |
|--------|---------|
| EOA | ~$13.88 USDT |
| Safe | ~$5.00 USDT (from previous session auto-funds) |
| **Total** | **~$18.88 USDT** |

### Auto-Fund (21:55:55 → 21:56:01)

- Safe deficit: $3.00 (threshold $8 for new maxTradeSize, had $5)
- Transfer: $3.00 from EOA → Safe
- Tx: `0x63665246183817c0f31f016abb96d8e3201e34f53274b6589955adf0f5194714` (block 83357143)

| Wallet | After Auto-Fund |
|--------|----------------|
| EOA | ~$10.88 USDT |
| Safe | ~$8.00 USDT |

### Trade 1: Market 929 — NO FILL (21:56:03 → 21:56:07)

| Field | Value |
|-------|-------|
| Internal Market ID | 512 |
| Predict Market ID | 929 |
| Spread | 230 bps |
| Leg A (Predict) | BUY at $0.205, $4 size |
| Leg B (Probable) | BUY at $0.758, $4 size |
| Predict Order ID | 14379766 |
| Result | **EXPIRED** — FOK didn't fill, $0 spent |

Fill check: `eoaSpent: 0`, threshold: $0.40. Probable leg correctly skipped.

| Wallet | After Trade 1 |
|--------|---------------|
| EOA | ~$10.88 USDT (unchanged) |
| Safe | ~$8.00 USDT (unchanged) |

### Trade 2: Market 1528 — PARTIAL (21:56:13 → 21:56:31)

| Field | Value |
|-------|-------|
| Internal Market ID | 395 |
| Predict Market ID | 1528 |
| Spread | 172 bps |
| Exchange | `0x8A289d458f5a134bA40015085A8F50Ffb681B41d` (negRisk, yieldBearing) |
| Leg A (Predict) | BUY at $0.014, $4 size → **FILLED** |
| Leg B (Probable) | BUY at $0.949, $4 size → **REJECTED** |
| Predict Order ID | 14380093 |
| Predict Token | `21808188434...501984` |
| Probable Token | `30328088284...014763` |

**Predict leg filled:**
- `eoaSpent: 3.9999999999399996` (~$4.00)
- ~285 outcome tokens purchased ($4 / $0.014)

**Probable leg rejected:**
```
Probable placeOrder failed: 502
ME REST service error: 400 Bad Request
Code: -4014 — "Price not increased by tick size."
Price attempted: 0.949
```

**Unwind attempts (all failed):**

| Attempt | Price | Discount | Error |
|---------|-------|----------|-------|
| 1 | $0.0133 | 5% | `NonMatchingAmountsError: Maker/Taker Limit amounts do not match order price` |
| 2 | $0.0126 | 10% | Same error |
| 3 | $0.0112 | 20% | Same error |

Each attempt also retried 3 times internally (9 total API calls). All rejected with same error.

Auto-unpaused after exhausting retries.

| Wallet | After Trade 2 |
|--------|---------------|
| EOA | ~$6.88 USDT + ~285 Predict tokens (market 1528) |
| Safe | ~$8.00 USDT (unchanged — Probable never executed) |

### Trade 3: Market 896 — PARTIAL (21:56:36 → 21:56:55)

| Field | Value |
|-------|-------|
| Internal Market ID | 389 |
| Predict Market ID | 896 |
| Spread | 166 bps |
| Exchange | `0x8BC070BEdAB741406F4B1Eb65A72bee27894B689` (non-negRisk) |
| Leg A (Predict) | BUY at $0.231, $4 size → **FILLED** |
| Leg B (Probable) | BUY at $0.737, $4 size → **REJECTED** |
| Predict Order ID | 14380294 |
| Predict Token | `98876737971...734170` |
| Probable Token | `83050469286...399452` |

**Predict leg filled:**
- `eoaSpent: 4.00000000092` (~$4.00)
- ~17.3 outcome tokens purchased ($4 / $0.231)

**Probable leg rejected (identical error):**
```
ME REST service error: 400 Bad Request
Code: -4014 — "Price not increased by tick size."
Price attempted: 0.737
```

**Unwind attempts (all failed — identical error):**

| Attempt | Price | Discount | Error |
|---------|-------|----------|-------|
| 1 | $0.2195 | 5% | `NonMatchingAmountsError` |
| 2 | $0.2079 | 10% | `NonMatchingAmountsError` |
| 3 | $0.1848 | 20% | `NonMatchingAmountsError` |

Auto-unpaused after exhausting retries.

| Wallet | After Trade 3 |
|--------|---------------|
| EOA | ~$2.88 USDT + tokens from trades 2 & 3 |
| Safe | ~$8.00 USDT (unchanged) |

### Post-Trade State

Agent continued scanning but every opportunity is now skipped:
```
CLOB: insufficient EOA USDT balance, skipping
balance: 2.877994397549361, required: 4
```

---

## Final Balance Summary

| Asset | Location | Value |
|-------|----------|-------|
| USDT | EOA | ~$2.88 |
| USDT | Safe | ~$8.00 |
| Predict tokens (market 1528) | EOA | ~285 tokens (bought at $0.014, ~$4 cost basis) |
| Predict tokens (market 896) | EOA | ~17.3 tokens (bought at $0.231, ~$4 cost basis) |
| **Total USDT liquid** | | **~$10.88** |
| **Total cost basis in tokens** | | **~$8.00** |
| **Grand total (at cost)** | | **~$18.88** (matches starting balance) |

No money is missing. $8 was converted from USDT into Predict outcome tokens that couldn't be sold back due to the unwind bug. The tokens still have value and can be manually sold or redeemed at market resolution.

---

## Root Cause Analysis

### Bug 1: Probable "Price not increased by tick size" (CRITICAL)

**Every Probable order was rejected before reaching the matching engine.**

Prices attempted: 0.949, 0.758, 0.737. The Probable ME (PancakeSwap-based matching engine) requires prices to align with specific tick sizes. Our code sends raw float prices without rounding to the tick grid.

This means **no Probable trade can ever succeed** — every arb will result in naked Predict exposure.

**Likely fix:** Query or hardcode the Probable tick size (likely 0.001 or 0.005) and round prices to the nearest valid tick before placing orders. Need to check Probable API docs (Cloudflare-protected — need user to provide).

**Affected code:** `packages/agent/src/clob/probable-client.ts` — `placeOrder()` method, price passed to `buildOrder()`.

### Bug 2: Predict LIMIT "Maker/Taker amounts do not match order price" (CRITICAL)

**Every unwind SELL order was rejected by Predict.**

Prices attempted across both trades: 0.0133, 0.0126, 0.0112, 0.2195, 0.2079, 0.1848. The error `NonMatchingAmountsError` means `buildOrder()` computes `makerAmount` and `takerAmount` values that don't satisfy Predict's price validation: `makerAmount / takerAmount ≠ price` (within tolerance).

This happens because:
1. The LIMIT strategy path in `predict-client.ts` sets `slippageBps: 0` but `buildOrder()` in `signing.ts` still applies slippage logic based on params
2. At low prices ($0.01-0.02), integer rounding in BigInt arithmetic creates ratios that drift from the intended price
3. Predict's validation is stricter for LIMIT orders than MARKET orders

This means **no unwind can ever succeed** — any filled Predict leg with a failed Probable leg results in permanently stranded tokens.

**Affected code:**
- `packages/agent/src/clob/signing.ts` — `buildOrder()` BigInt arithmetic at low prices
- `packages/agent/src/clob/predict-client.ts` — LIMIT order parameter construction
- `packages/agent/src/execution/executor.ts` — `attemptUnwind()` price/amount computation

### Bug 3: Auto-unpause allows compounding losses (HIGH)

The auto-unpause after failed unwind (our earlier fix) worked as designed — but in this case it allowed the agent to immediately execute another trade that hit the exact same bugs. Trade 2 failed and auto-unpaused, then Trade 3 immediately fired and failed identically, doubling the losses.

**The auto-unpause should NOT resume trading if the failure was a systematic bug** (same error type repeatedly) vs a transient failure (timeout, network blip).

### Additional issue: DepositWatcher Postgres bigint overflow

```
PostgresError: value "10000000000000000000" is out of range for type bigint
```

When EOA balance exceeded ~9.22 USDT (max Postgres bigint = 9,223,372,036,854,775,807), the DepositWatcher crashed. BSC USDT uses 18 decimals, so 10 USDT = 10^19 > max bigint. The DB column storing raw balances needs to be `numeric` or `text` type.

---

## Timeline

```
21:55:52  Agent started
21:55:55  Auto-fund: $3 EOA → Safe (tx confirmed block 83357143)
21:56:01  Approvals verified (Probable + Predict)
21:56:03  Scan: 4 opportunities found, best 230 bps

21:56:03  TRADE 1 (market 929): Predict BUY $0.205
21:56:04  Predict order placed (ID: 14379766)
21:56:07  Fill check: $0 spent → not filled → EXPIRED ✓

21:56:13  TRADE 2 (market 1528): Predict BUY $0.014
21:56:15  Predict order placed (ID: 14380093)
21:56:18  Fill check: $4.00 spent → FILLED
21:56:18  Probable BUY $0.949 → REJECTED (tick size) ✗
21:56:18  Unwind attempt 1: SELL $0.0133 → REJECTED (amount mismatch)
21:56:23  Unwind attempt 2: SELL $0.0126 → REJECTED (amount mismatch)
21:56:27  Unwind attempt 3: SELL $0.0112 → REJECTED (amount mismatch)
21:56:31  All unwinds exhausted → auto-unpause

21:56:36  TRADE 3 (market 896): Predict BUY $0.231
21:56:38  Predict order placed (ID: 14380294)
21:56:41  Fill check: $4.00 spent → FILLED
21:56:42  Probable BUY $0.737 → REJECTED (tick size) ✗
21:56:42  Unwind attempt 1: SELL $0.2195 → REJECTED (amount mismatch)
21:56:47  Unwind attempt 2: SELL $0.2079 → REJECTED (amount mismatch)
21:56:51  Unwind attempt 3: SELL $0.1848 → REJECTED (amount mismatch)
21:56:55  All unwinds exhausted → auto-unpause

21:57:00  Scan: insufficient balance ($2.88 < $4 required)
21:57:00+ Agent keeps scanning, all trades skipped (insufficient balance)
```

---

## Immediate Action Items

1. **STOP the agent** — every Probable order will fail, compounding naked Predict exposure
2. **Fix Bug 1** (Probable tick size) — must align prices to ME tick grid
3. **Fix Bug 2** (Predict LIMIT amounts) — `buildOrder()` needs correct amount computation for LIMIT orders
4. **Fix Bug 3** (Auto-unpause logic) — don't resume after systematic errors, only transient ones
5. **Fix DepositWatcher** — change Postgres column from `bigint` to `numeric`/`text`
6. **Manual recovery** — sell the stranded Predict tokens (markets 1528 + 896) once unwind bug is fixed, or wait for market resolution

## Stranded Token Positions

| Market | Predict Market ID | Token ID | ~Qty | Cost Basis | Buy Price |
|--------|-------------------|----------|------|-----------|-----------|
| 395 | 1528 | `21808188434...501984` | ~285 | $4.00 | $0.014 |
| 389 | 896 | `98876737971...734170` | ~17.3 | $4.00 | $0.231 |

---

## Fix Attempts

### Try 1 (2026-02-25)

**Research findings:**

- **Bug 1 root cause**: `buildOrder()` quantize step (lines 51-58) produces tick-aligned prices (0.949, 0.758, 0.737). Then slippage inflate (line 72: `makerAmount *= 10100/10000`) destroys the ratio. 0.949 → 0.95849 (not on 0.001 grid). Probable ME computes price from makerAmount/takerAmount ratio and validates against tick grid.
- **Bug 2 root cause**: `buildOrder()` computes `sizeRaw` and `sharesRaw` independently from floating-point `size` and `size/price`. Predict server validates `takerAmount == (pricePerShareWei * makerAmount) / 1e18` exactly. Independent BigInt truncation creates tiny mismatches (e.g. 10M wei off for price 0.0133). The Predict SDK derives one amount from the other: for SELL, `takerAmount = (price * makerAmount) / 1e18`. Also applies `retainSignificantDigits` (3 sigfigs for price, 5 for quantity).
- **Bug 3 root cause**: Auto-unpause doesn't distinguish systematic errors (all unwind orders rejected at API level = code bug) from transient errors (orders placed but didn't fill = liquidity/timing). Trade 2 auto-unpaused → Trade 3 immediately hit same bugs.

**Approach:**

1. **Bug 1 fix** (`signing.ts`): After slippage block, when `quantize=true` and `slipBps > 0`, snap the implied price back to the 0.001 tick grid. For BUY, ceil the price ticks (pay slightly more, stays within slippage). For SELL, floor the price ticks (accept slightly less).

2. **Bug 2 fix** (`signing.ts` + `predict-client.ts`): For Predict LIMIT orders (no slippage, scale=1e18, no quantize), derive the dependent amount from the independent one via exact price arithmetic. Use two-step multiply (`Math.round(price * 1e8) * 1e10`) to avoid IEEE 754 precision loss on priceWei. Also fix `pricePerShare` in predict-client.ts to use same two-step multiply.

3. **Bug 3 fix** (`executor.ts`): Track whether any unwind order was successfully placed (but didn't fill) vs all were rejected at API level. If all rejected → systematic bug → stay paused. If some placed → transient → auto-unpause.

**Files to modify:**
- `packages/agent/src/clob/signing.ts` — `buildOrder()`: tick re-quantization + derive-amounts
- `packages/agent/src/clob/predict-client.ts` — `pricePerShare` precision fix
- `packages/agent/src/execution/executor.ts` — `attemptUnwind()` systematic vs transient detection

**Status:** COMPLETE — all 3 bugs verified fixed (Bug 1 + Bug 2 live, Bug 3 unit-tested)

**Test results:** 25/25 passing (`executor-clob.test.ts`)
- Bug 1 fix: post-slippage tick re-quantization verified — live Probable order accepted
- Bug 2 fix: derive-amounts + GCD quantum + 3dp price — live LIMIT SELL orders accepted (201)
- Bug 3 fix: 7 existing tests updated to reflect new behavior:
  - Tests where `placeOrder` returns `{ success: false }` or throws → now expect `isPaused() === true` (systematic)
  - Tests where `placeOrder` succeeds but order expires → still expect `isPaused() === false` (transient)

**Files modified:**
- `packages/agent/src/clob/signing.ts` — `buildOrder()`: GCD helper, post-slippage tick re-quantization, derive-amounts with quantum alignment for Predict LIMIT
- `packages/agent/src/clob/predict-client.ts` — `pricePerShare` two-step multiply (line 366)
- `packages/agent/src/execution/executor.ts` — `attemptUnwind()` systematic vs transient detection + 3dp unwind price
- `packages/agent/src/__tests__/executor-clob.test.ts` — test assertions updated for Bug 3 + 3dp price
- `packages/platform/src/scripts/test-predict-sell.ts` — Bug 2 verification script (new)

**Live test results (2026-02-25 ~22:28 UTC):**

EOA funded with additional $5 (~$7.88 total). Agent started from frontend.

- **Trade 1** (market 512/929, 230 bps): Predict FOK at $0.205 → not filled → EXPIRED ✓ (no action needed)
- **Trade 2** (market 395/1528, 172 bps): **FIRST SUCCESSFUL ARB TRADE**
  - Predict: BUY at $0.014, $4 → FILLED (EOA spent $4.00)
  - Probable: BUY at $0.949, $4 → FILLED (Safe spent $4.00, order accepted at tick-aligned price $0.959)
  - Position ID: `clob-1772058554977-goz9o5`
  - Both legs confirmed filled — complete arb position
- **Trade 3+** (market 695/896, 166 bps): Predict rejected with `CollateralPerMarketExceededError` — stranded tokens from yesterday's failed trades block this market. Not a code bug.

**Bug 1 (Probable tick size): VERIFIED FIXED** — Probable order accepted at price 0.959 (tick-aligned after slippage). Previously all Probable orders were rejected with "-4014 Price not increased by tick size."

**Bug 2 (Predict LIMIT amounts): VERIFIED FIXED** — Tested via `test-predict-sell.ts` script placing LIMIT SELL orders for stranded tokens:
- Market 896 (standard exchange): SELL at $0.219 → **201 Created** (orderId 14402457) → **FILLED** (~$3.79 returned to EOA)
- Market 1528 (negRisk + yieldBearing exchange): SELL at $0.013 → **201 Created** (orderId 14402465) → **FILLED** (~$3.71 returned to EOA)
- DepositWatcher confirmed: `8.036894838` USDT deposited back to EOA
- Previously all unwind SELL orders were rejected with `NonMatchingAmountsError`.
- Additional fixes required beyond initial Try 1:
  - **Amount precision (InvalidPrecisionError)**: Predict requires `amount % 1e10 === 0`. Added GCD-based quantum alignment to `buildOrder()` — quantizes independent amount so derived amount is also 1e10-aligned.
  - **Price precision (InvalidPrecisionError)**: Predict requires max 3 decimal places. Changed unwind price rounding from 4dp to 3dp in `executor.ts`.

**Probable SELL: VERIFIED** — Tested via `test-probable-sell.ts` placing a FOK SELL on Probable for tokens from today's arb trade:
- Market 395 (Probable leg): SELL at $0.892, qty 1.10 → **200 OK** (orderId 10747) → **FILLED** (~$1.04 returned to Safe)
- Safe balance went from ~$4.00 → ~$5.04 confirming fill.

**Bug 3 (Auto-unpause logic): NOT YET TESTED** — No partial fill occurred, so the systematic vs transient detection was never triggered. Needs a partial fill scenario to verify. Unit tests pass (25/25) but live validation still pending.

### Post-verification balances

| Wallet | Balance | Notes |
|--------|---------|-------|
| EOA | ~$11.91 USDT | Recovered $8.04 from stranded Predict tokens |
| Safe | ~$5.04 USDT | Recovered $1.04 from Probable SELL test |
| **Total liquid** | **~$16.95 USDT** | Up from $10.88 post-incident (stranded tokens liquidated) |
