# Incident Report: Test Run 2026-02-25

## Summary

Agent ran 3 trades in ~30 seconds. All 3 had the same failure pattern: Predict leg filled, Probable leg rejected ("tick size" error), unwind failed ("amount mismatch" error). Result: $8 of USDT converted to Predict tokens that couldn't be sold back. No money is lost — it's sitting as tokens in the EOA wallet — but it's illiquid until manually unwound or the bugs are fixed.

---

## Wallets

| Wallet | Address |
|--------|---------|
| EOA | `0xdAD013D95aCB067B2431fde18cbAc2BC92EF6B6C` |
| Safe | `0xD2d193AbB6Ca9365C4D32E52e26a7264F30FfCF9` |

## Agent Config (at time of trades)

| Setting | Value |
|---------|-------|
| maxTradeSize | $8 (per-leg = $4) |
| minTradeSize | $3 |
| minSpreadBps | 150 |
| executionMode | clob |
| dryRun | false |

---

## Money Trail

### Starting Balances (before agent start)

| Wallet | Balance |
|--------|---------|
| EOA | ~$13.88 USDT |
| Safe | ~$5.00 USDT (from previous session auto-funds) |
| **Total** | **~$18.88 USDT** |

### Auto-Fund (21:55:55 → 21:56:01)

- Safe deficit: $3.00 (threshold $8 for new maxTradeSize, had $5)
- Transfer: $3.00 from EOA → Safe
- Tx: `0x63665246183817c0f31f016abb96d8e3201e34f53274b6589955adf0f5194714` (block 83357143)

| Wallet | After Auto-Fund |
|--------|----------------|
| EOA | ~$10.88 USDT |
| Safe | ~$8.00 USDT |

### Trade 1: Market 929 — NO FILL (21:56:03 → 21:56:07)

| Field | Value |
|-------|-------|
| Internal Market ID | 512 |
| Predict Market ID | 929 |
| Spread | 230 bps |
| Leg A (Predict) | BUY at $0.205, $4 size |
| Leg B (Probable) | BUY at $0.758, $4 size |
| Predict Order ID | 14379766 |
| Result | **EXPIRED** — FOK didn't fill, $0 spent |

Fill check: `eoaSpent: 0`, threshold: $0.40. Probable leg correctly skipped.

| Wallet | After Trade 1 |
|--------|---------------|
| EOA | ~$10.88 USDT (unchanged) |
| Safe | ~$8.00 USDT (unchanged) |

### Trade 2: Market 1528 — PARTIAL (21:56:13 → 21:56:31)

| Field | Value |
|-------|-------|
| Internal Market ID | 395 |
| Predict Market ID | 1528 |
| Spread | 172 bps |
| Exchange | `0x8A289d458f5a134bA40015085A8F50Ffb681B41d` (negRisk, yieldBearing) |
| Leg A (Predict) | BUY at $0.014, $4 size → **FILLED** |
| Leg B (Probable) | BUY at $0.949, $4 size → **REJECTED** |
| Predict Order ID | 14380093 |
| Predict Token | `21808188434...501984` |
| Probable Token | `30328088284...014763` |

**Predict leg filled:**
- `eoaSpent: 3.9999999999399996` (~$4.00)
- ~285 outcome tokens purchased ($4 / $0.014)

**Probable leg rejected:**
```
Probable placeOrder failed: 502
ME REST service error: 400 Bad Request
Code: -4014 — "Price not increased by tick size."
Price attempted: 0.949
```

**Unwind attempts (all failed):**

| Attempt | Price | Discount | Error |
|---------|-------|----------|-------|
| 1 | $0.0133 | 5% | `NonMatchingAmountsError: Maker/Taker Limit amounts do not match order price` |
| 2 | $0.0126 | 10% | Same error |
| 3 | $0.0112 | 20% | Same error |

Each attempt also retried 3 times internally (9 total API calls). All rejected with same error.

Auto-unpaused after exhausting retries.

| Wallet | After Trade 2 |
|--------|---------------|
| EOA | ~$6.88 USDT + ~285 Predict tokens (market 1528) |
| Safe | ~$8.00 USDT (unchanged — Probable never executed) |

### Trade 3: Market 896 — PARTIAL (21:56:36 → 21:56:55)

| Field | Value |
|-------|-------|
| Internal Market ID | 389 |
| Predict Market ID | 896 |
| Spread | 166 bps |
| Exchange | `0x8BC070BEdAB741406F4B1Eb65A72bee27894B689` (non-negRisk) |
| Leg A (Predict) | BUY at $0.231, $4 size → **FILLED** |
| Leg B (Probable) | BUY at $0.737, $4 size → **REJECTED** |
| Predict Order ID | 14380294 |
| Predict Token | `98876737971...734170` |
| Probable Token | `83050469286...399452` |

**Predict leg filled:**
- `eoaSpent: 4.00000000092` (~$4.00)
- ~17.3 outcome tokens purchased ($4 / $0.231)

**Probable leg rejected (identical error):**
```
ME REST service error: 400 Bad Request
Code: -4014 — "Price not increased by tick size."
Price attempted: 0.737
```

**Unwind attempts (all failed — identical error):**

| Attempt | Price | Discount | Error |
|---------|-------|----------|-------|
| 1 | $0.2195 | 5% | `NonMatchingAmountsError` |
| 2 | $0.2079 | 10% | `NonMatchingAmountsError` |
| 3 | $0.1848 | 20% | `NonMatchingAmountsError` |

Auto-unpaused after exhausting retries.

| Wallet | After Trade 3 |
|--------|---------------|
| EOA | ~$2.88 USDT + tokens from trades 2 & 3 |
| Safe | ~$8.00 USDT (unchanged) |

### Post-Trade State

Agent continued scanning but every opportunity is now skipped:
```
CLOB: insufficient EOA USDT balance, skipping
balance: 2.877994397549361, required: 4
```

---

## Final Balance Summary

| Asset | Location | Value |
|-------|----------|-------|
| USDT | EOA | ~$2.88 |
| USDT | Safe | ~$8.00 |
| Predict tokens (market 1528) | EOA | ~285 tokens (bought at $0.014, ~$4 cost basis) |
| Predict tokens (market 896) | EOA | ~17.3 tokens (bought at $0.231, ~$4 cost basis) |
| **Total USDT liquid** | | **~$10.88** |
| **Total cost basis in tokens** | | **~$8.00** |
| **Grand total (at cost)** | | **~$18.88** (matches starting balance) |

No money is missing. $8 was converted from USDT into Predict outcome tokens that couldn't be sold back due to the unwind bug. The tokens still have value and can be manually sold or redeemed at market resolution.

---

## Root Cause Analysis

### Bug 1: Probable "Price not increased by tick size" (CRITICAL)

**Every Probable order was rejected before reaching the matching engine.**

Prices attempted: 0.949, 0.758, 0.737. The Probable ME (PancakeSwap-based matching engine) requires prices to align with specific tick sizes. Our code sends raw float prices without rounding to the tick grid.

This means **no Probable trade can ever succeed** — every arb will result in naked Predict exposure.

**Likely fix:** Query or hardcode the Probable tick size (likely 0.001 or 0.005) and round prices to the nearest valid tick before placing orders. Need to check Probable API docs (Cloudflare-protected — need user to provide).

**Affected code:** `packages/agent/src/clob/probable-client.ts` — `placeOrder()` method, price passed to `buildOrder()`.

### Bug 2: Predict LIMIT "Maker/Taker amounts do not match order price" (CRITICAL)

**Every unwind SELL order was rejected by Predict.**

Prices attempted across both trades: 0.0133, 0.0126, 0.0112, 0.2195, 0.2079, 0.1848. The error `NonMatchingAmountsError` means `buildOrder()` computes `makerAmount` and `takerAmount` values that don't satisfy Predict's price validation: `makerAmount / takerAmount ≠ price` (within tolerance).

This happens because:
1. The LIMIT strategy path in `predict-client.ts` sets `slippageBps: 0` but `buildOrder()` in `signing.ts` still applies slippage logic based on params
2. At low prices ($0.01-0.02), integer rounding in BigInt arithmetic creates ratios that drift from the intended price
3. Predict's validation is stricter for LIMIT orders than MARKET orders

This means **no unwind can ever succeed** — any filled Predict leg with a failed Probable leg results in permanently stranded tokens.

**Affected code:**
- `packages/agent/src/clob/signing.ts` — `buildOrder()` BigInt arithmetic at low prices
- `packages/agent/src/clob/predict-client.ts` — LIMIT order parameter construction
- `packages/agent/src/execution/executor.ts` — `attemptUnwind()` price/amount computation

### Bug 3: Auto-unpause allows compounding losses (HIGH)

The auto-unpause after failed unwind (our earlier fix) worked as designed — but in this case it allowed the agent to immediately execute another trade that hit the exact same bugs. Trade 2 failed and auto-unpaused, then Trade 3 immediately fired and failed identically, doubling the losses.

**The auto-unpause should NOT resume trading if the failure was a systematic bug** (same error type repeatedly) vs a transient failure (timeout, network blip).

### Additional issue: DepositWatcher Postgres bigint overflow

```
PostgresError: value "10000000000000000000" is out of range for type bigint
```

When EOA balance exceeded ~9.22 USDT (max Postgres bigint = 9,223,372,036,854,775,807), the DepositWatcher crashed. BSC USDT uses 18 decimals, so 10 USDT = 10^19 > max bigint. The DB column storing raw balances needs to be `numeric` or `text` type.

---

## Timeline

```
21:55:52  Agent started
21:55:55  Auto-fund: $3 EOA → Safe (tx confirmed block 83357143)
21:56:01  Approvals verified (Probable + Predict)
21:56:03  Scan: 4 opportunities found, best 230 bps

21:56:03  TRADE 1 (market 929): Predict BUY $0.205
21:56:04  Predict order placed (ID: 14379766)
21:56:07  Fill check: $0 spent → not filled → EXPIRED ✓

21:56:13  TRADE 2 (market 1528): Predict BUY $0.014
21:56:15  Predict order placed (ID: 14380093)
21:56:18  Fill check: $4.00 spent → FILLED
21:56:18  Probable BUY $0.949 → REJECTED (tick size) ✗
21:56:18  Unwind attempt 1: SELL $0.0133 → REJECTED (amount mismatch)
21:56:23  Unwind attempt 2: SELL $0.0126 → REJECTED (amount mismatch)
21:56:27  Unwind attempt 3: SELL $0.0112 → REJECTED (amount mismatch)
21:56:31  All unwinds exhausted → auto-unpause

21:56:36  TRADE 3 (market 896): Predict BUY $0.231
21:56:38  Predict order placed (ID: 14380294)
21:56:41  Fill check: $4.00 spent → FILLED
21:56:42  Probable BUY $0.737 → REJECTED (tick size) ✗
21:56:42  Unwind attempt 1: SELL $0.2195 → REJECTED (amount mismatch)
21:56:47  Unwind attempt 2: SELL $0.2079 → REJECTED (amount mismatch)
21:56:51  Unwind attempt 3: SELL $0.1848 → REJECTED (amount mismatch)
21:56:55  All unwinds exhausted → auto-unpause

21:57:00  Scan: insufficient balance ($2.88 < $4 required)
21:57:00+ Agent keeps scanning, all trades skipped (insufficient balance)
```

---

## Immediate Action Items

1. **STOP the agent** — every Probable order will fail, compounding naked Predict exposure
2. **Fix Bug 1** (Probable tick size) — must align prices to ME tick grid
3. **Fix Bug 2** (Predict LIMIT amounts) — `buildOrder()` needs correct amount computation for LIMIT orders
4. **Fix Bug 3** (Auto-unpause logic) — don't resume after systematic errors, only transient ones
5. **Fix DepositWatcher** — change Postgres column from `bigint` to `numeric`/`text`
6. **Manual recovery** — sell the stranded Predict tokens (markets 1528 + 896) once unwind bug is fixed, or wait for market resolution

## Stranded Token Positions

| Market | Predict Market ID | Token ID | ~Qty | Cost Basis | Buy Price |
|--------|-------------------|----------|------|-----------|-----------|
| 395 | 1528 | `21808188434...501984` | ~285 | $4.00 | $0.014 |
| 389 | 896 | `98876737971...734170` | ~17.3 | $4.00 | $0.231 |

---

## Fix Attempts

### Try 1 (2026-02-25)

**Research findings:**

- **Bug 1 root cause**: `buildOrder()` quantize step (lines 51-58) produces tick-aligned prices (0.949, 0.758, 0.737). Then slippage inflate (line 72: `makerAmount *= 10100/10000`) destroys the ratio. 0.949 → 0.95849 (not on 0.001 grid). Probable ME computes price from makerAmount/takerAmount ratio and validates against tick grid.
- **Bug 2 root cause**: `buildOrder()` computes `sizeRaw` and `sharesRaw` independently from floating-point `size` and `size/price`. Predict server validates `takerAmount == (pricePerShareWei * makerAmount) / 1e18` exactly. Independent BigInt truncation creates tiny mismatches (e.g. 10M wei off for price 0.0133). The Predict SDK derives one amount from the other: for SELL, `takerAmount = (price * makerAmount) / 1e18`. Also applies `retainSignificantDigits` (3 sigfigs for price, 5 for quantity).
- **Bug 3 root cause**: Auto-unpause doesn't distinguish systematic errors (all unwind orders rejected at API level = code bug) from transient errors (orders placed but didn't fill = liquidity/timing). Trade 2 auto-unpaused → Trade 3 immediately hit same bugs.

**Approach:**

1. **Bug 1 fix** (`signing.ts`): After slippage block, when `quantize=true` and `slipBps > 0`, snap the implied price back to the 0.001 tick grid. For BUY, ceil the price ticks (pay slightly more, stays within slippage). For SELL, floor the price ticks (accept slightly less).

2. **Bug 2 fix** (`signing.ts` + `predict-client.ts`): For Predict LIMIT orders (no slippage, scale=1e18, no quantize), derive the dependent amount from the independent one via exact price arithmetic. Use two-step multiply (`Math.round(price * 1e8) * 1e10`) to avoid IEEE 754 precision loss on priceWei. Also fix `pricePerShare` in predict-client.ts to use same two-step multiply.

3. **Bug 3 fix** (`executor.ts`): Track whether any unwind order was successfully placed (but didn't fill) vs all were rejected at API level. If all rejected → systematic bug → stay paused. If some placed → transient → auto-unpause.

**Files to modify:**
- `packages/agent/src/clob/signing.ts` — `buildOrder()`: tick re-quantization + derive-amounts
- `packages/agent/src/clob/predict-client.ts` — `pricePerShare` precision fix
- `packages/agent/src/execution/executor.ts` — `attemptUnwind()` systematic vs transient detection

**Status:** COMPLETE — all 3 bugs verified fixed (Bug 1 + Bug 2 live, Bug 3 unit-tested)

**Test results:** 25/25 passing (`executor-clob.test.ts`)
- Bug 1 fix: post-slippage tick re-quantization verified — live Probable order accepted
- Bug 2 fix: derive-amounts + GCD quantum + 3dp price — live LIMIT SELL orders accepted (201)
- Bug 3 fix: 7 existing tests updated to reflect new behavior:
  - Tests where `placeOrder` returns `{ success: false }` or throws → now expect `isPaused() === true` (systematic)
  - Tests where `placeOrder` succeeds but order expires → still expect `isPaused() === false` (transient)

**Files modified:**
- `packages/agent/src/clob/signing.ts` — `buildOrder()`: GCD helper, post-slippage tick re-quantization, derive-amounts with quantum alignment for Predict LIMIT
- `packages/agent/src/clob/predict-client.ts` — `pricePerShare` two-step multiply (line 366)
- `packages/agent/src/execution/executor.ts` — `attemptUnwind()` systematic vs transient detection + 3dp unwind price
- `packages/agent/src/__tests__/executor-clob.test.ts` — test assertions updated for Bug 3 + 3dp price
- `packages/platform/src/scripts/test-predict-sell.ts` — Bug 2 verification script (new)

**Live test results (2026-02-25 ~22:28 UTC):**

EOA funded with additional $5 (~$7.88 total). Agent started from frontend.

- **Trade 1** (market 512/929, 230 bps): Predict FOK at $0.205 → not filled → EXPIRED ✓ (no action needed)
- **Trade 2** (market 395/1528, 172 bps): **FIRST SUCCESSFUL ARB TRADE**
  - Predict: BUY at $0.014, $4 → FILLED (EOA spent $4.00)
  - Probable: BUY at $0.949, $4 → FILLED (Safe spent $4.00, order accepted at tick-aligned price $0.959)
  - Position ID: `clob-1772058554977-goz9o5`
  - Both legs confirmed filled — complete arb position
- **Trade 3+** (market 695/896, 166 bps): Predict rejected with `CollateralPerMarketExceededError` — stranded tokens from yesterday's failed trades block this market. Not a code bug.

**Bug 1 (Probable tick size): VERIFIED FIXED** — Probable order accepted at price 0.959 (tick-aligned after slippage). Previously all Probable orders were rejected with "-4014 Price not increased by tick size."

**Bug 2 (Predict LIMIT amounts): VERIFIED FIXED** — Tested via `test-predict-sell.ts` script placing LIMIT SELL orders for stranded tokens:
- Market 896 (standard exchange): SELL at $0.219 → **201 Created** (orderId 14402457) → **FILLED** (~$3.79 returned to EOA)
- Market 1528 (negRisk + yieldBearing exchange): SELL at $0.013 → **201 Created** (orderId 14402465) → **FILLED** (~$3.71 returned to EOA)
- DepositWatcher confirmed: `8.036894838` USDT deposited back to EOA
- Previously all unwind SELL orders were rejected with `NonMatchingAmountsError`.
- Additional fixes required beyond initial Try 1:
  - **Amount precision (InvalidPrecisionError)**: Predict requires `amount % 1e10 === 0`. Added GCD-based quantum alignment to `buildOrder()` — quantizes independent amount so derived amount is also 1e10-aligned.
  - **Price precision (InvalidPrecisionError)**: Predict requires max 3 decimal places. Changed unwind price rounding from 4dp to 3dp in `executor.ts`.

**Probable SELL: VERIFIED** — Tested via `test-probable-sell.ts` placing a FOK SELL on Probable for tokens from today's arb trade:
- Market 395 (Probable leg): SELL at $0.892, qty 1.10 → **200 OK** (orderId 10747) → **FILLED** (~$1.04 returned to Safe)
- Safe balance went from ~$4.00 → ~$5.04 confirming fill.

**Bug 3 (Auto-unpause logic): NOT YET TESTED** — No partial fill occurred, so the systematic vs transient detection was never triggered. Needs a partial fill scenario to verify. Unit tests pass (25/25) but live validation still pending.

### Post-verification balances

| Wallet | Balance | Notes |
|--------|---------|-------|
| EOA | ~$11.91 USDT | Recovered $8.04 from stranded Predict tokens |
| Safe | ~$5.04 USDT | Recovered $1.04 from Probable SELL test |
| **Total liquid** | **~$16.95 USDT** | Up from $10.88 post-incident (stranded tokens liquidated) |

---

# Incident #2: 2026-02-26 ~00:02–00:06 UTC

## Summary

Agent started with EOA ~$18.20, Safe ~$6.00 ($24.20 total). In under 4 minutes, executed 5 trade attempts. **Two new bugs** drained the EOA to ~$0.28. One successful arb trade (market 695). Three one-sided Predict positions ($12 total) stranded and unable to unwind. Previous bugs (tick size, NonMatchingAmountsError) remain fixed — these are **new failure modes**.

## Wallets

Same as incident #1:
| Wallet | Address |
|--------|---------|
| EOA | `0xdAD013D95aCB067B2431fde18cbAc2BC92EF6B6C` |
| Safe | `0xD2d193AbB6Ca9365C4D32E52e26a7264F30FfCF9` |

## Money Trail

### Starting Balances

| Wallet | Balance |
|--------|---------|
| EOA | ~$18.20 USDT |
| Safe | ~$6.00 USDT |
| **Total** | **~$24.20 USDT** |

### Auto-Fund (00:02:02 → 00:02:08)

- Safe deficit: $1.92 (threshold $8 for maxTradeSize, had ~$6)
- Transfer: $1.92 EOA → Safe
- Tx: `0x51402b0d2f509a4984a7999e31e3952c56a4cffe7821fa8004989e6844d04bc0` (block 83373921)

| Wallet | After Auto-Fund |
|--------|----------------|
| EOA | ~$16.28 |
| Safe | ~$7.92 |

### Trade 1: Market 711 — PARTIAL (00:02:10 → 00:02:32)

| Field | Value |
|-------|-------|
| Predict Market ID | 1344 |
| Spread | 764 bps |
| Leg A (Predict) | BUY at $0.32, $4 → **FILLED** (eoaSpent: $4.00) |
| Leg B (Probable) | BUY at $0.59, $4 → **FOK placed but NOT FILLED** (safeSpent: $0) |
| Predict Order ID | 14435356 |
| Probable Order ID | 4205 |

**Probable response:** `status: "NEW"`, `price: "0.596000"`, `origQty: "6.770000"`, **`executedQty: "0"`**. Tick-aligned price (fix from incident #1 working). Order was accepted by ME but FOK found no counter-party → cancelled. Balance check confirms $0 Safe spend.

**Unwind attempts (all rejected — NEW error):**

| Attempt | Price | Error |
|---------|-------|-------|
| 1 | $0.304 | `Insufficient shares: currentTokenAmount=13.16, amountAvailable=12.25` |
| 2 | $0.288 | `Insufficient shares: currentTokenAmount=13.89, amountAvailable=12.25` |
| 3 | $0.256 | `Insufficient shares: currentTokenAmount=15.63, amountAvailable=12.25` |

All rejected → **systematic** → executor paused ✓ (Bug 3 fix working)

| Wallet | After Trade 1 |
|--------|---------------|
| EOA | ~$12.28 + Predict tokens (mkt 1344) |
| Safe | ~$7.92 (unchanged) |

### Trade 2: Market 711 — PARTIAL (00:04:19 → 00:04:49)

Identical to Trade 1 — exact same market, same failure. Executor had been paused but **auto-unpaused after getOrderStatus returned 404** (order gone → treated as CANCELLED → `anyPlaced = true` → transient → unpause).

| Field | Value |
|-------|-------|
| Predict Order ID | 14436570 |
| Probable Order ID | 4206 |
| Result | **PARTIAL** — same pattern |

Unwind: first attempt placed successfully (orderId 14436643), polled, got 404 (CANCELLED). Set `anyPlaced = true`. Subsequent attempts rejected with "Insufficient shares". Since `anyPlaced = true` → **transient** → auto-unpaused.

| Wallet | After Trade 2 |
|--------|---------------|
| EOA | ~$8.28 + more Predict tokens |
| Safe | ~$7.92 (unchanged) |

### Trade 3: Market 512 — EXPIRED (00:04:55 → 00:05:00)

Predict FOK at $0.205 didn't fill → `eoaSpent: 0` → EXPIRED. No loss. ✓

### Trade 4: Market 695 — FILLED (00:05:06 → 00:05:15)

| Field | Value |
|-------|-------|
| Predict Market ID | 896 |
| Spread | 166 bps |
| Leg A (Predict) | BUY at $0.231, $4 → **FILLED** |
| Leg B (Probable) | BUY at $0.737, $4 → **FILLED** (safeSpent: $3.99) |
| Position ID | `clob-1772064311826-81eihu` |

Both legs confirmed filled. ✓

| Wallet | After Trade 4 |
|--------|---------------|
| EOA | ~$4.28 |
| Safe | ~$3.92 |

### Trade 5: Market 389 — PARTIAL (00:05:20 → 00:05:38)

| Field | Value |
|-------|-------|
| Predict Market ID | 1523 |
| Spread | 153 bps |
| Leg A (Predict) | BUY at $0.067, $4.005 → **FILLED** (eoaSpent: $4.005) |
| Leg B (Probable) | BUY at $0.899, $4.005 → **REJECTED** (`PAS-4200: Insufficient collateral balance`) |
| Predict Order ID | 14437006 |

Probable rejected at API level (Safe had $3.92, needed ~$4.01). Safe balance check was stale (capped to $4.005 but didn't account for Probable fee overhead).

Unwind: all 3 attempts rejected with "Insufficient shares" (same bug as Trade 1). All rejected → systematic → executor stays paused ✓.

| Wallet | After Trade 5 |
|--------|---------------|
| EOA | ~$0.28 + Predict tokens (mkts 1344 + 1523) |
| Safe | ~$3.92 |

## Final Balance Summary

| Asset | Location | Value |
|-------|----------|-------|
| USDT | EOA | ~$0.28 |
| USDT | Safe | ~$3.92 |
| Predict tokens (market 1344) | EOA | 2× ~12.5 shares ($8 cost basis) |
| Predict tokens (market 1523) | EOA | ~59.7 shares ($4 cost basis) |
| Arb position (market 695) | EOA + Safe | $8 cost basis, expected $8.13 payout |
| **Total liquid** | | **~$4.20** |
| **Total illiquid (at cost)** | | **~$20.00** |
| **Grand total (at cost)** | | **~$24.20** (matches starting balance) |

---

## Root Cause Analysis

### Bug 4: Unwind SELL uses USDT amount as `size`, requiring more shares than owned (CRITICAL)

**This is why every unwind fails with "Insufficient shares".**

`attemptUnwind()` passes `size = leg.filledSize` (= `sizeUsdt` = $4) and a discounted price to `placeOrder()`. In `buildOrder()`, for a SELL order:

```
makerAmount (shares to sell) = size / price
```

At the **original** BUY price ($0.32), $4 gets 12.5 shares. But the SELL uses a **discounted** price:
- 5% discount → price $0.304 → needs $4/$0.304 = **13.16 shares** (we only have 12.5!)
- 10% → $0.288 → needs **13.89 shares**
- 20% → $0.256 → needs **15.63 shares**

**The deeper the discount, the worse the deficit.** The unwind is mathematically guaranteed to fail because it tries to sell more shares than exist.

The previous bug (NonMatchingAmountsError) was about precision in BigInt arithmetic. This bug is about **using the wrong unit for SELL size**. The fix in incident #1 made the order valid, but now the order requests impossible share counts.

**Fix:** The SELL size should be based on the shares actually acquired, not the USDT amount. Either:
1. Pass `size = sizeUsdt * sellPrice / buyPrice` (reduce USDT to match available shares), or
2. Track actual shares purchased and pass that as the SELL size, or
3. Compute `size = leg.size * (1 - discount)` so the USDT amount shrinks with the price discount

**Affected code:** `executor.ts:attemptUnwind()` line 831, 846

### Bug 5: Probable FOK not filling on thin markets (HIGH)

Market 711 has a 764 bps spread — the highest — but Probable FOK orders consistently fail (`executedQty: 0`). The order is accepted (status: NEW, tick-aligned price) but the FOK finds no counter-party.

This is not a code bug — it's a **stale quote / thin liquidity** issue. The scanner reports spreads based on best-bid/ask, but the Probable order book for market 711 has no real depth to fill a FOK.

The problem is the agent keeps targeting market 711 because it has the highest spread, losing $4 to Predict each time.

**Fix:** After a Probable FOK fails for a market, temporarily blacklist that market (e.g. 10-minute cooldown). Don't re-attempt the same market that just failed.

**Affected code:** `executor.ts:executeClob()` — needs market-level cooldown tracking

### Bug 6: Safe balance check doesn't account for Probable fee overhead (MEDIUM)

Trade 5: Safe had $3.92, executor capped trade size to $4.005 (Safe balance), but Probable rejected with "Insufficient collateral balance" because the 1.75% fee wasn't fully covered. The pre-check at line 354 uses `sizeUsdt * 1.0175` but the actual Probable order cost includes fee on top of the base amount differently.

**Affected code:** `executor.ts` line 354 — Safe balance threshold calculation

### Bug 3 Regression: Auto-unpause triggered by 404 on unwind order poll

Trade 2 unwind: first SELL order was placed (orderId 14436643), then `getOrderStatus` returned 404. The code treats 404 as CANCELLED, sets `anyPlaced = true`, and since `anyPlaced` → transient → auto-unpause.

But the 404 might mean the order was rejected after initial acceptance, or it's a Predict API quirk. The `anyPlaced` flag was set because the order was initially created (201), but it never actually reached the book. This let the agent unpause and immediately lose another $4 on the same market.

**Affected code:** `executor.ts:attemptUnwind()` — 404 handling needs to not count as "order reached matching engine"

---

## Timeline

```
00:02:02  Auto-fund: $1.92 EOA → Safe (tx confirmed block 83373921)
00:02:09  Approvals verified

00:02:10  TRADE 1 (market 711/1344, 764 bps): Predict BUY $0.32
00:02:11  Predict order placed (ID: 14435356) → FILLED ($4 from EOA)
00:02:15  Probable BUY $0.596 → placed (ID: 4205, status: NEW)
00:02:18  Probable fill check: safeSpent=$0 → NOT FILLED (FOK cancelled)
00:02:18  PARTIAL FILL — executor paused
00:02:19  Unwind 1: SELL $0.304 → REJECTED (Insufficient shares: need 13.16, have 12.25)
00:02:24  Unwind 2: SELL $0.288 → REJECTED (Insufficient shares: need 13.89, have 12.25)
00:02:28  Unwind 3: SELL $0.256 → REJECTED (Insufficient shares: need 15.63, have 12.25)
00:02:32  All rejected (systematic) → stays paused ✓

00:04:17  Agent restarted (user re-triggered from frontend)
00:04:19  TRADE 2 (market 711/1344 again, 764 bps): Predict BUY $0.32
00:04:21  Predict order placed (ID: 14436570) → FILLED ($4 from EOA)
00:04:24  Probable BUY $0.596 → placed (ID: 4206, status: NEW)
00:04:27  Probable fill check: safeSpent=$0 → NOT FILLED
00:04:27  PARTIAL FILL — executor paused
00:04:29  Unwind 1: SELL $0.304 → placed (ID: 14436643)
00:04:40  Unwind 1 poll: 404 → treated as CANCELLED, anyPlaced=true
00:04:40  Unwind 2: SELL $0.288 → REJECTED (Insufficient shares)
00:04:45  Unwind 3: SELL $0.256 → REJECTED (Insufficient shares)
00:04:49  anyPlaced=true → transient → auto-unpaused ✗ (Bug 3 regression)

00:04:55  TRADE 3 (market 512/929): Predict FOK → not filled → EXPIRED ✓
00:05:06  TRADE 4 (market 695/896): Both legs FILLED ✓
00:05:20  TRADE 5 (market 389/1523): Predict FILLED, Probable rejected (insufficient Safe balance)
00:05:25  Unwind: all 3 rejected (Insufficient shares) → stays paused ✓
```

## Immediate Action Items

1. **STOP the agent** — done (executor paused itself after Trade 5)
2. **Fix Bug 4** (unwind share count) — SELL size must reflect actual shares, not USDT amount
3. **Fix Bug 5** (market cooldown) — blacklist markets where Probable FOK fails
4. **Fix Bug 6** (Safe balance check) — account for full Probable fee overhead
5. **Fix Bug 3 regression** (404 → anyPlaced) — 404 on order poll should not count as "placed"
6. **Manual recovery** — sell stranded Predict tokens (markets 1344 + 1523) via test script

## Stranded Token Positions

| Market | Predict Market ID | Token ID (truncated) | ~Qty | Cost Basis | Buy Price |
|--------|-------------------|----------------------|------|-----------|-----------|
| 711 | 1344 | `89259842800...` | 2× ~12.5 | $8.00 | $0.32 |
| 389 | 1523 | `11014239851...` | ~59.7 | $4.00 | $0.067 |

---

## Fix Attempt (2026-02-26)

### Bugs Fixed

All 4 bugs from Incident #2 fixed in `packages/agent/src/execution/executor.ts`:

**Bug 4 (Unwind SELL share count):**
- `attemptUnwind()` now computes `actualShares = sizeUsdt / buyPrice` and passes `size = actualShares * discountedPrice` to `placeOrder()`. This ensures `buildOrder()` computes `makerAmount = size / price = actualShares` — exactly the shares held, regardless of discount.

**Bug 3 regression (404 → anyPlaced):**
- Replaced `anyPlaced` flag with `anyReachedBook`. During order polling, tracks `sawLive` — only set true if status is `OPEN` or `PARTIAL`. A 404 on first poll (order never on book) no longer counts as transient. Only orders confirmed on the book trigger auto-unpause.

**Bug 5 (Market cooldown):**
- Added `marketCooldowns: Map<string, number>` with 30-minute TTL. At top of `executeClob()`, skip markets with active cooldowns. Cooldown set after: (a) Probable API rejection, (b) Probable balance check shows FOK didn't fill.

**Bug 6 (Safe balance fee overhead):**
- Changed fee multiplier from `1.0175` to `FEE_MULTIPLIER = 1.02` (2% buffer). When capping trade size to Safe balance, divides by fee multiplier: `safeBalance / FEE_MULTIPLIER`.

**Test results:** 28/28 passing (`executor-clob.test.ts`)
- New tests: Bug 4 regression (incident #2 exact numbers), Bug 5 market cooldown, immediately-cancelled unwind detection
- Updated tests: fee cap assertion (`toBeCloseTo(1.9608, 3)`), transient detection (OPEN before EXPIRED)

### Stranded Token Recovery

Ran `packages/platform/src/scripts/sell-all-predict.ts` to sell stranded Predict positions.

**Run 1 (pre-fix):** Script had simplified exchange selection (only STANDARD and YIELD_NEGRISK). Market 1344 failed with "Invalid signature" because it's `yieldBearing=true` (not negRisk), needed YIELD exchange (`0x6bEb...`), not YIELD_NEGRISK (`0x8A28...`).

**Fix:** Added all 4 exchange contracts to sell script with proper 4-way selection logic matching `predict-client.ts`.

**Run 2 (post-fix):**

| Market | Predict ID | Shares | Sell Price | Result |
|--------|-----------|--------|------------|--------|
| 1344 (Based FDV) | 14454033 | 11.34 | $0.248 | SOLD (orderId 14454033) |
| 896 (Opensea FDV) | 14452340 | 17.02 | $0.184 | SOLD (orderId 14452340) |
| 1523 (Portugal WC) | 14452332 | 58.59 | $0.053 | SOLD (orderId 14452332) |
| 1528 (Belgium WC) | — | 0.31 | $0 | SKIPPED (dust) |
| 1169 (Opinion FDV) | — | 0.15 | $0 | SKIPPED (dust) |

Recovery: ~$2.81 + ~$3.13 + ~$3.11 = **~$9.05** returned from $12 cost basis (25% loss from 20% discount sells).

### Live Test (2026-02-26 00:50 UTC)

Restarted platform with all bug fixes. Agent started from frontend.

**Result:** Agent immediately targeted Market 711/1344 again (764 bps spread — highest available). Same failure:

1. Predict BUY at $0.32, $4 → **FILLED** (orderId 14458216, 12.5 shares)
2. Probable BUY at $0.596 → placed (orderId 4210), `executedQty: 0` → **FOK not filled**
3. **PARTIAL FILL** — executor paused
4. Unwind attempts: all 3 rejected with "Insufficient shares" — available was 12.26 (not 12.5) because previous sell-all-predict.ts LIMIT order still had ~0.24 shares locked on the book
5. Correctly classified as **systematic** → executor stays paused (Bug 3 fix verified)

**Bug 5 cooldown was empty** — in-memory map doesn't survive restarts. Market 1344 was re-targeted because there was no cooldown entry.

**Additional loss:** $4 (another 12.5 shares stranded at $0.32 buy price on Market 1344).

**Run 3 sell (post-test):** Sold 12.26 available shares at $0.249 → orderId 14459595 (~$3.05 recovered).

### Current Balances (2026-02-26 ~01:00 UTC)

| Wallet | Balance |
|--------|---------|
| EOA | ~$15.34 USDT |
| Safe | ~$4.01 USDT |
| **Total liquid** | **~$19.35 USDT** |

Plus dust positions (0.31, 0.15, 0.10 shares) on markets 1528, 1169, 1523, 896 — effectively $0.

### Remaining Issues

1. **Market 1344 Probable side never fills** — needs persistent blacklist (DB-backed), not just in-memory cooldown
2. **Unwind doesn't check available shares** — should query position's `amountAvailable` before trying to sell, not assume all held shares are free
3. **In-memory cooldown doesn't survive restarts** — market cooldowns should be persisted to DB or at minimum initialized from recent trade history on startup

---

# Incident #3: 2026-02-26 ~01:43 UTC

## Summary

Added `maxSpreadBps` cap (default 400 bps) to filter out high-spread illiquid traps like Market 1344 (764 bps). Agent started with EOA ~$7.08, Safe ~$8.00 ($15.08 total). First trade (market 512/929, 230 bps) expired harmlessly. Second trade (market 695/896, 166 bps) resulted in another partial fill: Predict filled, Probable FOK placed but `executedQty: 0`.

**The `maxSpreadBps` filter works** — 13 detected opportunities were narrowed to 4 actionable (previously all 13 would pass). But the core problem is deeper: **Probable FOK orders fail even on markets within the spread band because the order book has no executable depth at the quoted price.**

## Agent Config

| Setting | Value |
|---------|-------|
| maxTradeSize | $8 (per-leg = $4) |
| minTradeSize | $3 |
| minSpreadBps | 150 |
| **maxSpreadBps** | **400** (NEW — filters out >4% spread markets) |
| executionMode | clob |
| dryRun | false |

## Money Trail

### Starting Balances

| Wallet | Balance |
|--------|---------|
| EOA | ~$7.08 USDT |
| Safe | ~$8.00 USDT |
| **Total** | **~$15.08 USDT** |

### Trade 1: Market 512/929 — EXPIRED (01:43:14 → 01:43:18)

| Field | Value |
|-------|-------|
| Spread | 230 bps |
| Leg A (Predict) | BUY at $0.205, $4 → **NOT FILLED** |
| Predict Order ID | 14485956 |
| Result | **EXPIRED** — FOK didn't fill, $0 spent ✓ |

### Trade 2: Market 695/896 — PARTIAL (01:43:24 → 01:43:33)

| Field | Value |
|-------|-------|
| Spread | 166 bps |
| Leg A (Predict) | BUY at $0.231, $4 → **FILLED** (eoaSpent: $4.00) |
| Leg B (Probable) | BUY NO at $0.737 (effective $0.745 with slippage), qty 5.42 → **FOK NOT FILLED** |
| Predict Order ID | 14486007 |
| Probable Order ID | 4363 |
| Probable Symbol | `POPENSEAFD695NOUSDT` |
| Position ID | `clob-1772070210256-tb0n5z` |

**Probable order response:** `status: "NEW"`, `price: "0.745000"`, `origQty: "5.420000"`, **`executedQty: "0"`**, `timeInForce: "FOK"`. Order was accepted by ME (tick-aligned price ✓) but FOK found no counter-party at that price → killed.

**Fill verification:** `safeSpent: 0`, threshold: $0.40 → `probableFilled: false`.

**Unwind:** Failed — `no available shares (all locked in open orders)`. Expected 17.3 shares, available: 0. Previous LIMIT orders from sell-all-predict script likely still holding shares on the book.

**Result:** PARTIAL → executor paused ✓

### Post-Trade Scans

Agent continued scanning every 5s. 4 actionable opportunities found each cycle but executor paused:
```
Executor is paused due to partial fill — skipping execution
```

### Final Balances

| Wallet | Balance |
|--------|---------|
| EOA | ~$3.08 USDT + ~17.3 Predict tokens (mkt 896, $0.231 basis) |
| Safe | ~$8.00 USDT (unchanged) |
| **Total liquid** | **~$11.08 USDT** |
| **Stranded (at cost)** | **~$4.00** |

## Root Cause: Probable Orderbook Liquidity

This is **not a code bug**. The flow worked correctly:

1. Scanner quotes show Probable NO @ 0.737 → spread exists on paper
2. `buildOrder()` applies 1% slippage → effective price $0.745 (tick-aligned ✓)
3. Probable ME accepts the FOK order (status: NEW)
4. **No counter-party on the book to fill against** → FOK cancelled → `executedQty: 0`
5. Balance check correctly detects $0 Safe spend → PARTIAL
6. Executor pauses (systematic classification ✓)

The scanner's "best ask" prices on Probable are either stale, thin, or represent bids too small to fill our $4 FOK. The spread is real in mid-market terms but there's no executable depth.

## Deeper Issue: Why Probable FOK Fails

Across all 3 incidents, Probable FOK fills have been inconsistent:

| Incident | Market | Probable Price | Fill? | Notes |
|----------|--------|---------------|-------|-------|
| #1 | 395 (1528) | $0.949 | NO | Tick size error (pre-fix) |
| #1 | 389 (896) | $0.737 | NO | Tick size error (pre-fix) |
| Post-fix | 395 (1528) | $0.949 | YES | First successful arb |
| #2 | 711 (1344) | $0.596 | NO | FOK, no counter-party (764 bps) |
| #2 | 695 (896) | $0.737 | YES | Successful arb |
| #2 | 389 (1523) | $0.899 | NO | Insufficient Safe balance |
| #3 | 695 (896) | $0.745 | NO | FOK, no counter-party (166 bps) |

Market 695/896 (Opensea FDV) filled once but failed the next attempt at nearly the same price. This suggests Probable liquidity is **ephemeral** — the book has depth one moment and is empty the next.

## Potential Fixes

1. **Pre-flight orderbook depth check** — Before placing Probable leg, query `GET /orderbook/{market}` and verify sufficient ask depth at our price. Skip if depth < trade size.
2. **GTC instead of FOK on Probable** — Let the order rest on the book and wait for a fill (with timeout). Risk: order may never fill, locking capital.
3. **Smaller trade sizes** — $2 instead of $4 may find fills on thinner books.
4. **Probable-first execution** — Place Probable GTC first (since it's the unreliable side), only place Predict FOK once Probable confirms filled. Reverses the current execution order.

---

## Fix: Probable Fill False Positive + EXPIRED Cooldown (2026-02-26)

### Problem

Two issues discovered from Probable-first execution flow:

1. **False positive fill detection**: Probable FOK returned `executedQty: "0"` (didn't fill), but Safe USDT dropped $1.08 (collateral lock by exchange). The 10% threshold ($0.40) triggered a false positive → code committed Predict capital for nothing.
2. **No cooldown on EXPIRED**: When Probable doesn't fill (EXPIRED), no cooldown was set. Agent immediately retried the same market next scan cycle. Market 929 retried 4+ times — always fails.

### Changes

**1. API-first fill check (`executor.ts`):**
- If `probableResult.filledQty` is available from the API response, use it directly: `filledQty > 0` → filled, `filledQty === 0` → not filled. No balance check needed.
- Falls back to balance check only when the API doesn't return the field.

**2. Surface `filledQty` from Probable API (`probable-client.ts`, `types.ts`):**
- Added `filledQty?: number` to `OrderResult` interface.
- Extracts `executedQty`/`filledQty`/`cumQty` from Probable's placeOrder response and returns it in the result.

**3. Raised balance fallback threshold from 10% to 50% (`executor.ts`):**
- Defense in depth: even without the API field, $1.08 < $2.00 (50% of $4) would have been correctly classified as non-fill. Previously $1.08 > $0.40 (10% of $4) was a false positive.

**4. 5-minute cooldown on EXPIRED path (`executor.ts`):**
- When Probable FOK doesn't fill, set a 5-minute cooldown on that market. Shorter than the 30-minute PARTIAL cooldown since no capital is lost, but prevents hammering the same market every 5 seconds.

### Files Modified

| File | Change |
|------|--------|
| `packages/agent/src/clob/types.ts` | Added `filledQty?: number` to `OrderResult` |
| `packages/agent/src/clob/probable-client.ts` | Extract `executedQty` → `filledQty` from API response |
| `packages/agent/src/execution/executor.ts` | API-first fill check, 50% threshold, EXPIRED cooldown |
| `packages/agent/src/__tests__/executor-clob.test.ts` | Tests for filledQty=0 → skip Predict, filledQty>0 → proceed |

### Test Results

336/336 passing. TypeScript clean (`tsc --noEmit`).

New tests:
- `filledQty=0` → correctly classified as non-fill, Predict leg never placed
- `filledQty > 0` → proceeds to Predict leg, both legs filled
