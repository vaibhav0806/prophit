services:
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: ["anvil", "--host", "0.0.0.0"]
    ports:
      - "8545:8545"
    healthcheck:
      test: ["CMD", "cast", "bn", "--rpc-url", "http://localhost:8545"]
      interval: 5s
      timeout: 3s
      retries: 10

  contracts:
    image: ghcr.io/foundry-rs/foundry:latest
    depends_on:
      anvil:
        condition: service_healthy
    working_dir: /app
    volumes:
      - ./packages/contracts:/app
    entrypoint: ["forge", "script", "script/Deploy.s.sol", "--rpc-url", "http://anvil:8545", "--broadcast"]
    environment:
      # Default anvil private key (account 0)
      PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"

  agent:
    build:
      context: .
      dockerfile: packages/agent/Dockerfile
    depends_on:
      contracts:
        condition: service_completed_successfully
    ports:
      - "3001:3001"
    env_file:
      - path: .env
        required: false
    environment:
      RPC_URL: http://anvil:8545
      PORT: "3001"

  frontend:
    build:
      context: .
      dockerfile: packages/frontend/Dockerfile
    depends_on:
      - agent
    ports:
      - "3000:3000"
    environment:
      AGENT_URL: http://agent:3001
      HOSTNAME: "0.0.0.0"
      PORT: "3000"
